@model WebApp.Models.UserProfile

@{
    ViewData["Title"] = "Create Profile";
    Layout = null;
    @using System.Text.Json

    var preferredLanguages = new[] {
        ("en", "English"),
        ("pt-BR", "Português (Brasil)"),
        ("es", "Español"),
    };

    var readingLanguages = new[] {
        ("en", "English"),
        ("pt-BR", "Português (Brasil)"),
        ("es", "Español"),
        ("fr", "Français"),
        ("de", "Deutsch"),
        ("it", "Italiano"),
        ("ja", "日本語"),
    };

    var learningStyles = new[] {
        ("concise", "Concise"),
        ("detailed", "Step-by-step"),
        ("socratic", "Socratic"),
        ("examples", "Examples"),
    };

    var tones = new[] {
        ("neutral", "Neutral"),
        ("friendly", "Friendly"),
        ("motivational", "Motivational"),
        ("no-nonsense", "No-nonsense"),
    };

    var genres = new[] {
        ("sci-fi", "Sci-Fi"),
        ("fantasy", "Fantasy"),
        ("mystery", "Mystery"),
        ("history", "History"),
        ("philosophy", "Philosophy"),
        ("biography", "Biography"),
        ("self-help", "Self-help"),
        ("technology", "Technology"),
        ("business", "Business"),
        ("classics", "Classics"),
    };

    static HashSet<string> JsonArrayToSet(JsonDocument? doc)
    {
        if (doc is null) return new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        if (doc.RootElement.ValueKind != JsonValueKind.Array) return new HashSet<string>(StringComparer.OrdinalIgnoreCase);

        var set = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        foreach (var el in doc.RootElement.EnumerateArray())
        {
            if (el.ValueKind == JsonValueKind.String)
                set.Add(el.GetString() ?? "");
        }
        return set;
    }

    static string? JsonFirstString(JsonDocument? doc)
    {
        if (doc is null) return null;
        if (doc.RootElement.ValueKind != JsonValueKind.Array) return null;
        var first = doc.RootElement.EnumerateArray().FirstOrDefault();
        return first.ValueKind == JsonValueKind.String ? first.GetString() : null;
    }

    var selectedReading = JsonArrayToSet(Model?.ReadingLanguages);
    var selectedLoved = JsonArrayToSet(Model?.LovedGenres);
    var selectedDisliked = JsonArrayToSet(Model?.DislikedGenres);
    var selectedLearningStyle = JsonFirstString(Model?.LearningStyle) ?? "examples";

    var isExisting = Model is not null && Model.Id != Guid.Empty && !string.IsNullOrWhiteSpace(Model.UserId);
}

<div class="min-h-screen">
    <div class="font-base max-w-[900px] mx-auto px-4 py-6">

        <div class="mb-4">
            <h2 class="font-title text-xl">@(isExisting ? "My profile" : "Create your profile")</h2>
            <p class="opacity-80">
                @(isExisting
                    ? $"Update your preferences. Last updated: {Model?.UpdatedAt:dd/MM/yyyy}"
                    : "This helps the assistant personalize answers and recommendations.")
            </p>
        </div>



        <form asp-action="Create"
            method="post"
            hx-post="@Url.Action("Upsert", "UserProfile")"
            hx-target="#alert"
            hx-swap="beforeend"
            class="flex flex-col gap-4">

            <div asp-validation-summary="ModelOnly"></div>

                <!-- Essentials -->
                <div class="flex flex-col gap-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <sl-input name="Nickname"
                                  value="@Model?.Nickname"
                                  label="Nickname"
                                  help-text="How should the assistant call you?"
                                  maxlength="50"
                                  required>
                        </sl-input>
                        <span asp-validation-for="Nickname"></span>

                        <sl-select name="PreferredLanguage"
                                   label="Preferred language"
                                   help-text="Used for UI defaults and assistant replies."
                                   value="@(Model?.PreferredLanguage ?? "en")"
                                   required>
                            @foreach (var (val, buf) in preferredLanguages)
                            {
                                <sl-option value="@val">@buf</sl-option>
                            }
                        </sl-select>
                        <span asp-validation-for="PreferredLanguage"></span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <sl-select name="TonePreference"
                                   label="Tone"
                                   help-text="How should the assistant sound?"
                                   value="@(Model?.TonePreference ?? "friendly")">
                            @foreach (var (val, buf) in tones)
                            {
                                <sl-option value="@val">@buf</sl-option>
                            }
                        </sl-select>
                        <span asp-validation-for="TonePreference"></span>

                        <div>
                            <label class="block mb-2 opacity-90 font-title">Learning style</label>
                            <sl-radio-group name="LearningStyle" value="@selectedLearningStyle">
                                <div class="flex flex-wrap gap-3">
                                    @foreach (var (val, label) in learningStyles)
                                    {
                                        <sl-radio value="@val">@label</sl-radio>
                                    }
                                </div>
                            </sl-radio-group>
                            <div class="text-sm opacity-70 mt-1">How you prefer explanations.</div>
                        </div>
                    </div>

                    <sl-textarea name="LearningGoals"
                                 value="@Model?.LearningGoals"
                                 label="Learning goals"
                                 help-text="Optional. 1–2 sentences is enough."
                                 maxlength="300"
                                 rows="3">
                    </sl-textarea>
                    <span asp-validation-for="LearningGoals"></span>
                </div>


                <div class="flex flex-col gap-3">

                    <sl-details summary="Reading preferences (optional)">
                        <div class="mt-3 flex flex-col gap-4">
                            <div>
                                <div class="mb-2 opacity-90 font-title">Reading languages</div>
                                <div class="flex flex-wrap gap-3">
                                    @foreach (var (val, label) in readingLanguages)
                                    {
                                        <sl-checkbox name="ReadingLanguages[]"  value="@val" checked="@(selectedReading.Contains(val))">@label</sl-checkbox>
                                    }
                                </div>
                                <div class="text-sm opacity-70 mt-2">
                                    Helps recommendations and summaries.
                                </div>
                            </div>

                            <sl-input name="FavoriteAuthors"
                                      value="@Model?.FavoriteAuthors"
                                      label="Favorite authors"
                                      help-text="Comma-separated. Example: Le Guin, Asimov, Lem"
                                      maxlength="200">
                            </sl-input>
                            <span asp-validation-for="FavoriteAuthors"></span>
                        </div>
                    </sl-details>

                    <sl-details summary="Genres (optional)">
                        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <div class="mb-2 opacity-90 font-title">Loved genres</div>
                                <div class="flex flex-wrap gap-3">
                                    @foreach (var (val, label) in genres)
                                    {
                                        <sl-checkbox name="LovedGenres[]" value="@val" @(selectedLoved.Contains(val) ? "checked" : "")>@label</sl-checkbox>
                                    }
                                </div>
                            </div>

                            <div>
                                <div class="mb-2 opacity-90 font-title">Disliked genres</div>
                                <div class="flex flex-wrap gap-3">
                                    @foreach (var (val, label) in genres)
                                    {
                                        <sl-checkbox name="DislikedGenres[]" value="@val" @(selectedDisliked.Contains(val) ? "checked" : "")>@label</sl-checkbox>
                                    }
                                </div>
                            </div>
                        </div>
                    </sl-details>

                    <sl-details summary="About you (optional)">
                        <div class="mt-3">
                            <sl-textarea name="AboutMe"
                                         value="@Model?.AboutMe"
                                         label="About me"
                                         help-text="Optional. Keep it short—this becomes part of your AI persona."
                                         maxlength="400"
                                         rows="4">
                            </sl-textarea>
                            <span asp-validation-for="AboutMe"></span>
                        </div>
                    </sl-details>

                </div>

                <div class="flex flex-col md:flex-row gap-3">
                    <sl-button type="submit" variant="primary" class="w-full" _="on click go to #header">
                        Save
                    </sl-button>
                </div>
        </form>
    </div>
</div>


@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
}
